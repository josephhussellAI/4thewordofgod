---
import Layout from '../../../layouts/Layout.astro';
import FloatingControls from '../../../components/FloatingControls.astro';
import FAQ from '../../../components/FAQ.astro';
import { getAllCommentary } from '../../../lib/content';
import { getLanguageDirection, LANGUAGES } from '../../../lib/languages';
import { books } from '../../../lib/books';

export async function getStaticPaths() {
  const allCommentary = await getAllCommentary();
  
  // Pre-calculate global data
  const allLanguages = [...new Set(allCommentary.map(e => e.data.language))].sort().map(code => ({
      language_code: code,
      tier_level: 1 as 1 | 2,
      direction: getLanguageDirection(code).toUpperCase() as 'LTR' | 'RTL',
      region_name: LANGUAGES[code]?.name || code
  }));

  return allCommentary.map(entry => {
    const [lang, book, chapter] = entry.slug.split('/');
    
    // Calculate bookChapters for this entry
    const bookChapters = allCommentary
      .filter(e => e.data.language === lang && e.slug.split('/')[1] === book)
      .sort((a, b) => {
         const aNum = parseInt(a.data.chapter, 10);
         const bNum = parseInt(b.data.chapter, 10);
         return aNum - bNum;
      })
      .map(e => ({
        chapter_number: e.data.chapter,
        original_title: e.data.title
      }));

    // Calculate firstChaptersMap for this entry's language
    const currentLangFirstChapters = {};
    books.forEach(b => {
        const bChapters = allCommentary
            .filter(e => e.data.language === lang && e.data.book.toLowerCase().replace(/\s+/g, '-') === b.slug)
            .map(e => e.data.chapter)
            .sort((a, b) => parseInt(a) - parseInt(b));
        
        currentLangFirstChapters[b.slug] = bChapters.length > 0 ? bChapters[0] : '01';
    });

    return {
      params: { lang, book, chapter },
      props: { 
        entry,
        bookChapters,
        allLanguages,
        firstChaptersMap: currentLangFirstChapters
      },
    };
  });
}

const { entry, bookChapters, allLanguages, firstChaptersMap } = Astro.props;

const { 
  title, 
  metaDescription, 
  keywords, 
  structuredData, 
  faq, 
  previous_chapter, 
  next_chapter, 
  audioPath,
  language: lang,
  book: bookName,
  chapter,
  content
} = entry.data;

// entry.slug is like "en/daniel/00"
const bookSlug = entry.slug.split('/')[1]; // "daniel"

const direction = getLanguageDirection(lang);

// Audio URL
const audioUrl = audioPath ? `https://audio.4thewordofgod.com/${audioPath}` : null;

// Parse prev/next chapter numbers
const getChapterNum = (str: string | null | undefined) => {
  if (!str) return null;
  const parts = str.split('_');
  return parts.length > 1 ? parts[1] : str; // Fallback if no underscore
};

let prevChapterNum = getChapterNum(previous_chapter);
let nextChapterNum = getChapterNum(next_chapter);

let prevArticleUrl: string | undefined;
let nextArticleUrl: string | undefined;

// Article Navigation Logic
if (entry.data.type === 'article') {
    // Get all articles for this language
    const articles = (await getAllCommentary())
        .filter(e => e.data.language === lang && e.data.type === 'article')
        .sort((a, b) => {
            const dateA = new Date(a.data.date || "2024-01-01");
            const dateB = new Date(b.data.date || "2024-01-01");
            return dateB.getTime() - dateA.getTime(); // Descending (Newest first)
        });

    const currentIndex = articles.findIndex(e => e.slug === entry.slug);
    
    if (currentIndex !== -1) {
        // Next (Newer) -> index - 1
        if (currentIndex > 0) {
            const nextArticle = articles[currentIndex - 1];
            nextArticleUrl = `/${nextArticle.slug}`;
        }
        
        // Previous (Older) -> index + 1
        if (currentIndex < articles.length - 1) {
            const prevArticle = articles[currentIndex + 1];
            prevArticleUrl = `/${prevArticle.slug}`;
        }
    }
}
---

<Layout 
  title={`${title} | Bible Commentary`} 
  dir={direction.toUpperCase() as 'LTR' | 'RTL'}
  description={metaDescription}
  ogTitle={title}
  ogDescription={metaDescription}
  keywords={keywords}
  structuredData={structuredData}
  languages={allLanguages}
  currentLang={lang}
  chapters={bookChapters}
  currentBook={bookSlug}
  currentChapter={chapter}
  firstChapters={firstChaptersMap}
>
  <main>
    
    <h1>{title}</h1>
    
    <FloatingControls 
      prevChapter={prevChapterNum}
      nextChapter={nextChapterNum}
      audioSrc={audioUrl}
      bookSlug={bookSlug}
      lang={lang}
      prevUrl={prevArticleUrl}
      nextUrl={nextArticleUrl}
    />
    
    <article class="commentary-text">
      <Fragment set:html={content} />
    </article>

    {faq && faq.length > 0 && (
      <FAQ items={faq} />
    )}
  </main>
</Layout>

<style>
  main {
    margin: auto;
    padding: 1rem;
    padding-bottom: 8rem; /* Space for floating nav */
    width: 100%;
    max-width: 1400px;
    font-size: 20px;
    line-height: 1.6;
    color: var(--theme-text);
  }

  .commentary-text {
    margin-top: 2rem;
    font-family: 'Lato', sans-serif;
  }
  
  /* Ensure images in markdown content are responsive */
  .commentary-text :global(img) {
    max-width: 100%;
    height: auto;
  }
</style>
